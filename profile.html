<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ - Ù…Ø³Ø§Ø±ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .emoji-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .emoji-option:hover {
            transform: scale(1.2);
        }
        .emoji-option.selected {
            background: #667eea;
            transform: scale(1.3);
        }
        .beta-banner {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        .dot {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50">

    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
    <div class="beta-banner text-white py-2 px-4 text-center text-xs sm:text-sm font-bold leading-relaxed">
        âœ¨ Ù†Ø¹Ù…Ù„ Ø®Ù„Ù Ø§Ù„ÙƒÙˆØ§Ù„ÙŠØ³ Ù„ØªØ·ÙˆÙŠØ± Ù…Ø³Ø§Ø±ÙŠ â€” Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ù‚Ø§Ø¯Ù…Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹
    </div>

    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
    <header class="gradient-bg text-white py-6">
        <div class="max-w-4xl mx-auto px-4 flex items-center gap-4">
            <button onclick="window.location.href='dashboard.html'" class="text-3xl hover:scale-110 transition-transform">
                â† 
            </button>
            <h1 class="text-2xl font-bold">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
        </div>
    </header>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
    <main class="max-w-4xl mx-auto px-4 py-8">

        <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­/Ø§Ù„Ø®Ø·Ø£ -->
        <div id="successMessage" class="hidden mb-4 p-4 bg-green-50 border border-green-200 rounded-xl text-green-700 text-sm"></div>
        <div id="errorMessage" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm"></div>

        <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -->
        <div class="bg-white rounded-3xl shadow-xl p-8 mb-6">
            
            <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
            <div class="text-center mb-8">
                <div class="w-32 h-32 mx-auto gradient-bg rounded-full flex items-center justify-center text-7xl mb-4" id="mainAvatar">
                    ğŸ‘¤
                </div>
                <h2 class="text-2xl font-bold mb-1" id="displayName">Ù…Ø³ØªØ®Ø¯Ù…</h2>
                <p class="text-gray-600" id="displayEmail">email@example.com</p>
            </div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -->
            <div class="mb-8">
                <label class="block text-lg font-bold mb-4">Ø§Ø®ØªØ± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ</label>
                <div class="grid grid-cols-6 gap-3">
                    <button onclick="selectEmoji('ğŸ‘¦')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ‘¦</button>
                    <button onclick="selectEmoji('ğŸ‘§')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ‘§</button>
                    <button onclick="selectEmoji('ğŸ§‘')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ§‘</button>
                    <button onclick="selectEmoji('ğŸ‘¨')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ‘¨</button>
                    <button onclick="selectEmoji('ğŸ‘©')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ‘©</button>
                    <button onclick="selectEmoji('ğŸ“')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ“</button>
                    <button onclick="selectEmoji('ğŸ“š')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ“š</button>
                    <button onclick="selectEmoji('âœ¨')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">âœ¨</button>
                    <button onclick="selectEmoji('ğŸŒŸ')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸŒŸ</button>
                    <button onclick="selectEmoji('ğŸš€')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸš€</button>
                    <button onclick="selectEmoji('ğŸ¯')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ¯</button>
                    <button onclick="selectEmoji('ğŸ’ª')" class="emoji-option p-4 rounded-xl border-2 border-gray-200 text-4xl hover:border-purple-400">ğŸ’ª</button>
                </div>
                <input type="hidden" id="selectedEmoji" value="ğŸ‘¤">
            </div>

            <!-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
            <div class="mb-8">
                <label class="block text-lg font-bold mb-3">Ø§Ù„Ø§Ø³Ù…</label>
                <input 
                    type="text" 
                    id="nameInput"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl text-right focus:outline-none focus:border-purple-500"
                    placeholder="Ø§Ø³Ù…Ùƒ"
                >
            </div>

            <!-- ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
            <div class="mb-8">
                <label class="block text-lg font-bold mb-3">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)</label>
                <input 
                    type="password" 
                    id="newPassword"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl text-right focus:outline-none focus:border-purple-500 mb-3"
                    placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±)"
                >
                <input 
                    type="password" 
                    id="confirmPassword"
                    class="w-full px-4 py-3 border border-gray-300 rounded-xl text-right focus:outline-none focus:border-purple-500"
                    placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                >
            </div>

            <!-- ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØµÙˆØª -->
            <div class="mb-8">
                <label class="flex items-center justify-between p-4 border border-gray-300 rounded-xl cursor-pointer hover:border-purple-400">
                    <span class="text-lg font-semibold flex items-center gap-2">
                        <span>ğŸ”Š</span>
                        ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØµÙˆØª
                    </span>
                    <div class="relative">
                        <input type="checkbox" id="soundToggle" class="sr-only" checked>
                        <div class="block bg-gray-300 w-14 h-8 rounded-full transition" id="soundToggleTrack"></div>
                        <div class="dot absolute right-1 top-1 bg-white w-6 h-6 rounded-full transition" id="soundToggleDot"></div>
                    </div>
                </label>
                <p class="text-sm text-gray-600 mt-2 mr-1">ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (ØµØ­ Ø£Ùˆ Ø®Ø·Ø£)</p>
            </div>

            <!-- Ø²Ø± Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª -->
            <button 
                onclick="saveProfile()"
                id="saveBtn"
                class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transform hover:scale-105 transition-all"
            >
                ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            </button>

        </div>

        <!-- Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ -->
        <button 
            onclick="logout()"
            class="w-full bg-red-500 hover:bg-red-600 text-white py-4 rounded-xl font-bold text-lg shadow-lg transform hover:scale-105 transition-all"
        >
            ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
        </button>

    </main>

    <script>
        // ============================================
        // ğŸ”§ Ø¥Ø¹Ø¯Ø§Ø¯ Supabase
        // ============================================
        const SUPABASE_URL = 'https://czzcmbxejxbotjemyuqf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6emNtYnhlanhib3RqZW15dXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg4MTYwNzcsImV4cCI6MjA1NDM5MjA3N30.ssII2KdmOcz1n-L3fo_tGdtHKBnPxLmEcJpWGBJBxDE';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentProfile = null;

        // ============================================
        // ğŸ¨ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ
        // ============================================
        function selectEmoji(emoji) {
            // Ø¥Ø²Ø§Ù„Ø© selected Ù…Ù† Ø§Ù„ÙƒÙ„
            document.querySelectorAll('.emoji-option').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Ø¥Ø¶Ø§ÙØ© selected Ù„Ù„Ù…Ø®ØªØ§Ø±
            const clickedButton = Array.from(document.querySelectorAll('.emoji-option')).find(btn => 
                btn.textContent.trim() === emoji
            );
            
            if (clickedButton) {
                clickedButton.classList.add('selected');
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠÙ…Ø©
            document.getElementById('selectedEmoji').value = emoji;
            document.getElementById('mainAvatar').textContent = emoji;
        }

        // ============================================
        // ğŸ”Š ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØª
        // ============================================
        const soundToggle = document.getElementById('soundToggle');
        const soundToggleTrack = document.getElementById('soundToggleTrack');
        const soundToggleDot = document.getElementById('soundToggleDot');

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
        soundToggle.checked = true;
        soundToggleTrack.classList.add('bg-purple-600');
        soundToggleTrack.classList.remove('bg-gray-300');
        soundToggleDot.style.transform = 'translateX(24px)';

        soundToggle.addEventListener('change', function() {
            if (this.checked) {
                soundToggleTrack.classList.remove('bg-gray-300');
                soundToggleTrack.classList.add('bg-purple-600');
                soundToggleDot.style.transform = 'translateX(24px)';
                localStorage.setItem('soundEnabled', 'true');
            } else {
                soundToggleTrack.classList.add('bg-gray-300');
                soundToggleTrack.classList.remove('bg-purple-600');
                soundToggleDot.style.transform = 'translateX(0)';
                localStorage.setItem('soundEnabled', 'false');
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        const soundEnabled = localStorage.getItem('soundEnabled');
        if (soundEnabled === 'false') {
            soundToggle.checked = false;
            soundToggleTrack.classList.add('bg-gray-300');
            soundToggleTrack.classList.remove('bg-purple-600');
            soundToggleDot.style.transform = 'translateX(0)';
        }

        // ============================================
        // âš ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        // ============================================
        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.classList.remove('hidden');
            
            setTimeout(() => {
                successDiv.classList.add('hidden');
            }, 3000);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // ============================================
        // ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        // ============================================
        async function loadCurrentData() {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    window.location.href = 'login.html';
                    return;
                }
                
                currentUser = user;
                
                // Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„:', profileError);
                    return;
                }
                
                currentProfile = profile;
                console.log('âœ… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ:', profile);
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                document.getElementById('displayName').textContent = profile?.name || currentUser.email.split('@')[0];
                document.getElementById('displayEmail').textContent = currentUser.email;
                document.getElementById('nameInput').value = profile?.name || '';
                
                const avatarEmoji = profile?.avatar_emoji || 'ğŸ‘¤';
                document.getElementById('mainAvatar').textContent = avatarEmoji;
                document.getElementById('selectedEmoji').value = avatarEmoji;
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ
                document.querySelectorAll('.emoji-option').forEach(btn => {
                    if (btn.textContent.trim() === profile.avatar_emoji) {
                        btn.classList.add('selected');
                    }
                });
                
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£:', err);
            }
        }

        // ============================================
        // ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        // ============================================
        async function saveProfile() {
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.innerHTML;
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
            
            try {
                const newName = document.getElementById('nameInput').value.trim();
                const newEmoji = document.getElementById('selectedEmoji').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§
                if (newPassword || confirmPassword) {
                    if (newPassword !== confirmPassword) {
                        showError('âš ï¸ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©');
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalText;
                        return;
                    }
                    
                    if (newPassword.length < 6) {
                        showError('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalText;
                        return;
                    }
                    
                    // ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                    const { error: passwordError } = await supabase.auth.updateUser({
                        password: newPassword
                    });
                    
                    if (passwordError) {
                        showError('âš ï¸ ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalText;
                        return;
                    }
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ù…Ø§)
                const updates = {};
                
                if (newName && newName !== currentProfile.name) {
                    updates.name = newName;
                }
                
                if (newEmoji !== currentProfile.avatar_emoji) {
                    updates.avatar_emoji = newEmoji;
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
                if (Object.keys(updates).length > 0) {
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update(updates)
                        .eq('id', currentUser.id);
                    
                    if (updateError) {
                        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«:', updateError);
                        showError('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸');
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalText;
                        return;
                    }
                }
                
                // Ù†Ø¬Ø­ Ø§Ù„Ø­ÙØ¸
                showSuccess('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                saveBtn.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸';
                
                setTimeout(() => {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                    
                    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    loadCurrentData();
                }, 1500);
                
            } catch (err) {
                console.error('âŒ Ø®Ø·Ø£:', err);
                showError('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹');
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        // ============================================
        // ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        // ============================================
        async function logout() {
            if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            }
        }

        // ============================================
        // ğŸš€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø©
        // ============================================
        loadCurrentData();
    </script>

</body>
</html>
