<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ â€” Ø®ÙˆØ§Ø±Ø²</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
    * { font-family: 'Tajawal', sans-serif; }
    body { background: #0f0c29; min-height: 100vh; }

    .glass {
        background: rgba(255,255,255,0.07);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
    }

    .progress-bar {
        height: 10px;
        border-radius: 999px;
        background: rgba(255,255,255,0.1);
        overflow: hidden;
    }
    .progress-fill {
        height: 100%;
        border-radius: 999px;
        transition: width 1s ease;
    }

    .topic-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .topic-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(139,92,246,0.3);
    }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: fadeIn 0.5s ease forwards; }

    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }
    .loading-pulse { animation: pulse 1.5s infinite; }

    .ai-report {
        background: linear-gradient(135deg, rgba(139,92,246,0.15), rgba(59,130,246,0.15));
        border: 1px solid rgba(139,92,246,0.3);
    }

    .section-tab { transition: all 0.2s; }
    .section-tab.active {
        background: linear-gradient(135deg, #7c3aed, #4f46e5);
        color: white;
    }

    .streak-badge {
        background: linear-gradient(135deg, #f59e0b, #ef4444);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }
</style>
</head>
<body>

<!-- Header -->
<div class="sticky top-0 z-50 glass border-b border-white/10">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
        <a href="index.html" class="flex items-center gap-2 text-white/70 hover:text-white transition-colors text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Ø±Ø¬ÙˆØ¹
        </a>
        <span class="text-white font-bold text-lg">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙŠ</span>
        <button onclick="generateAIReport()" id="aiBtn"
            class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1.5 rounded-full transition-colors flex items-center gap-1.5">
            <span>âœ¨</span> ØªÙ‚Ø±ÙŠØ± Ø°ÙƒÙŠ
        </button>
    </div>
</div>

<div class="max-w-4xl mx-auto px-4 py-6" id="mainContent">
    <!-- Loading -->
    <div id="loadingState" class="text-center py-20">
        <div class="text-white/50 loading-pulse text-lg">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ...</div>
    </div>

    <!-- Content (hidden until loaded) -->
    <div id="statsContent" class="hidden space-y-6">

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 fade-in">
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-black text-white" id="totalAnswered">0</div>
                <div class="text-white/50 text-xs mt-1">Ø³Ø¤Ø§Ù„ Ø­ÙÙ„Ù‘</div>
            </div>
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-black text-green-400" id="overallAccuracy">0%</div>
                <div class="text-white/50 text-xs mt-1">Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­</div>
            </div>
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-black text-yellow-400" id="bestTopic">â€”</div>
                <div class="text-white/50 text-xs mt-1">Ø£Ù‚ÙˆÙ‰ Ù…ÙˆØ¶ÙˆØ¹</div>
            </div>
            <div class="glass rounded-2xl p-4 text-center">
                <div class="text-3xl font-black text-red-400" id="weakestTopic">â€”</div>
                <div class="text-white/50 text-xs mt-1">ÙŠØ­ØªØ§Ø¬ ØªØ±ÙƒÙŠØ²</div>
            </div>
        </div>

        <!-- Section Tabs -->
        <div class="flex gap-2 fade-in">
            <button onclick="showSection('all')" class="section-tab active px-4 py-2 rounded-full text-sm font-bold text-white/70 glass" id="tab-all">Ø§Ù„ÙƒÙ„</button>
            <button onclick="showSection('quant')" class="section-tab px-4 py-2 rounded-full text-sm font-bold text-white/70 glass" id="tab-quant">âš¡ ÙƒÙ…ÙŠ</button>
            <button onclick="showSection('verbal')" class="section-tab px-4 py-2 rounded-full text-sm font-bold text-white/70 glass" id="tab-verbal">ğŸ“– Ù„ÙØ¸ÙŠ</button>
            <button onclick="showSection('tahsili')" class="section-tab px-4 py-2 rounded-full text-sm font-bold text-white/70 glass" id="tab-tahsili">ğŸ“ ØªØ­ØµÙŠÙ„ÙŠ</button>
        </div>

        <!-- Topics Grid -->
        <div id="topicsGrid" class="space-y-3 fade-in"></div>

        <!-- AI Report Section -->
        <div id="aiReportSection" class="hidden fade-in">
            <div class="ai-report rounded-2xl p-6">
                <div class="flex items-center gap-3 mb-4">
                    <span class="text-2xl">ğŸ¤–</span>
                    <div>
                        <div class="text-white font-bold text-lg">ØªÙ‚Ø±ÙŠØ±Ùƒ Ø§Ù„Ø°ÙƒÙŠ</div>
                        <div class="text-white/50 text-xs">ØªØ­Ù„ÙŠÙ„ Ù…Ø®ØµØµ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¦Ùƒ</div>
                    </div>
                </div>
                <div id="aiReportContent" class="text-white/80 leading-loose text-sm whitespace-pre-wrap"></div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="glass rounded-2xl p-5 fade-in">
            <div class="text-white font-bold mb-4 flex items-center gap-2">
                <span>ğŸ•</span> Ø¢Ø®Ø± Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
            </div>
            <div id="recentActivity" class="space-y-2"></div>
        </div>

    </div>
</div>

<script>
const sb = window.supabase.createClient(
    'https://czzcmbxejxbotjemyuqf.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6emNtYnhlanhib3RqZW15dXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNzQ0ODEsImV4cCI6MjA4NTc1MDQ4MX0.xDfG1qsDZGyUrpL44JfqOtk57dVsLaMsvIzJz1KgiR0'
);

const topicNames = {
    // ÙƒÙ…ÙŠ
    algebra: 'Ø¬Ø¨Ø±', arithmetic: 'Ø­Ø³Ø§Ø¨', geometry: 'Ù‡Ù†Ø¯Ø³Ø©', statistics: 'Ø¥Ø­ØµØ§Ø¡',
    // Ù„ÙØ¸ÙŠ
    analogy: 'ØªÙ†Ø§Ø¸Ø± Ù„ÙØ¸ÙŠ', comprehension: 'Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ù…Ù‚Ø±ÙˆØ¡', sentence_completion: 'Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…Ù„',
    // ØªØ­ØµÙŠÙ„ÙŠ
    biology: 'Ø£Ø­ÙŠØ§Ø¡', chemistry: 'ÙƒÙŠÙ…ÙŠØ§Ø¡', physics: 'ÙÙŠØ²ÙŠØ§Ø¡', math: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª'
};

const topicIcons = {
    algebra: 'ğŸ”¢', arithmetic: 'â•', geometry: 'ğŸ“', statistics: 'ğŸ“Š',
    analogy: 'ğŸ”—', comprehension: 'ğŸ“š', sentence_completion: 'âœï¸',
    biology: 'ğŸ§¬', chemistry: 'âš—ï¸', physics: 'âš¡', math: 'ğŸ“'
};

const sectionNames = { quant: 'ÙƒÙ…ÙŠ', verbal: 'Ù„ÙØ¸ÙŠ', tahsili: 'ØªØ­ØµÙŠÙ„ÙŠ' };

let allData = [];
let currentSection = 'all';

async 
function generateLocalReport(topicStats, total, overall) {
    const arr = Object.values(topicStats);
    const strong = arr.filter(t => t.total >= 3 && Math.round(t.correct/t.total*100) >= 70)
        .sort((a,b) => (b.correct/b.total) - (a.correct/a.total));
    const weak = arr.filter(t => t.total >= 3 && Math.round(t.correct/t.total*100) < 50)
        .sort((a,b) => (a.correct/a.total) - (b.correct/b.total));
    const medium = arr.filter(t => t.total >= 3 && Math.round(t.correct/t.total*100) >= 50 && Math.round(t.correct/t.total*100) < 70);

    let report = '';

    // ØªÙ‚ÙŠÙŠÙ… Ø¹Ø§Ù…
    if (overall >= 80) report += `ğŸŒŸ Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹! Ù†Ø³Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„ØµØ­ÙŠØ­Ø© ${overall}% ÙˆÙ‡Ø°Ø§ Ù…Ø³ØªÙˆÙ‰ Ù…Ù…ØªØ§Ø² ÙŠØ¹ÙƒØ³ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ø§Ù‹ Ù‚ÙˆÙŠØ§Ù‹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±.\n\n`;
    else if (overall >= 60) report += `ğŸ’ª Ø£Ø¯Ø§Ø¡ Ø¬ÙŠØ¯! Ø­Ù‚Ù‚Øª ${overall}% Ù†Ø³Ø¨Ø© ØµØ­ Ù…Ù† Ø£ØµÙ„ ${total} Ø³Ø¤Ø§Ù„. Ø£Ù†Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„ØµØ­ ÙˆØ¨Ù‚Ù„ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø³ØªØµÙ„ Ù„Ù…Ø³ØªÙˆÙ‰ Ø£Ø¹Ù„Ù‰.\n\n`;
    else if (overall >= 40) report += `ğŸ“ˆ Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ø¹Ø¯Ø©! Ù†Ø³Ø¨ØªÙƒ ${overall}% ÙˆØ¹Ù†Ø¯Ùƒ ÙØ±ØµØ© ÙƒØ¨ÙŠØ±Ø© Ù„Ù„ØªØ­Ø³Ù†. ÙƒÙ„ Ø³Ø¤Ø§Ù„ ØªØ­Ù„Ù‡ Ø§Ù„Ø¢Ù† ÙŠØ¶ÙŠÙ Ù„Ø±ØµÙŠØ¯Ùƒ.\n\n`;
    else report += `ğŸš€ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡! Ù†Ø³Ø¨ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ${overall}% ÙˆÙ‡Ø°Ø§ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø©. Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ù…Ø«Ø§Ø¨Ø±Ø© Ø³ÙŠØ­ÙˆÙ„Ø§Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¨Ø³Ø±Ø¹Ø©.\n\n`;

    // Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©
    if (strong.length > 0) {
        report += `âœ… Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©:\n`;
        strong.forEach(t => {
            const acc = Math.round(t.correct/t.total*100);
            report += `â€¢ ${topicNames[t.topic] || t.topic}: ${acc}% (${t.correct}/${t.total}) â€” Ù…Ù…ØªØ§Ø² ğŸ”¥\n`;
        });
        report += '\n';
    }

    // Ù…ÙˆØ§Ø¶ÙŠØ¹ Ù…ØªÙˆØ³Ø·Ø©
    if (medium.length > 0) {
        report += `âš¡ Ù…ÙˆØ§Ø¶ÙŠØ¹ ØªØ­ØªØ§Ø¬ ØªØ·ÙˆÙŠØ±:\n`;
        medium.forEach(t => {
            const acc = Math.round(t.correct/t.total*100);
            report += `â€¢ ${topicNames[t.topic] || t.topic}: ${acc}% â€” Ù‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ù‡Ø¯ÙØŒ Ø²ÙØ¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ù‚Ù„ÙŠÙ„Ø§Ù‹\n`;
        });
        report += '\n';
    }

    // Ù†Ù‚Ø§Ø· Ø§Ù„Ø¶Ø¹Ù
    if (weak.length > 0) {
        report += `âš ï¸ ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¹Ø§Ø¬Ù„Ø©:\n`;
        weak.forEach(t => {
            const acc = Math.round(t.correct/t.total*100);
            report += `â€¢ ${topicNames[t.topic] || t.topic}: ${acc}% â€” Ø±ÙƒÙ‘Ø² Ù‡Ù†Ø§ Ø£ÙˆÙ„Ø§Ù‹\n`;
        });
        report += '\n';
    }

    // Ø®Ø·Ø© Ø¹Ù…Ù„ÙŠØ©
    report += `ğŸ“‹ Ø®Ø·ØªÙƒ Ù„Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù‚Ø§Ø¯Ù…:\n`;
    if (weak.length > 0) {
        report += `1. Ø§Ø¨Ø¯Ø£ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© ${topicNames[weak[0].topic] || weak[0].topic} â€” Ø­Ù„ 20 Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹\n`;
        if (weak.length > 1) report += `2. Ø±Ø§Ø¬Ø¹ ${topicNames[weak[1].topic] || weak[1].topic} â€” Ø­Ù„ 15 Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹\n`;
        else report += `2. ÙƒØ±Ù‘Ø± Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ù…ØªÙˆØ³Ø·Ø© Ù„Ø±ÙØ¹ Ù…Ø³ØªÙˆØ§Ù‡Ø§ Ù„Ù„Ù…Ù…ØªØ§Ø²\n`;
    } else {
        report += `1. Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø­Ù„ 20 Ø³Ø¤Ø§Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹\n`;
        report += `2. Ø¬Ø±Ù‘Ø¨ ÙˆØ¶Ø¹ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„\n`;
    }
    report += `3. Ø±Ø§Ø¬Ø¹ Ø£Ø®Ø·Ø§Ø¡Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù‚Ø¨Ù„ ÙƒÙ„ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©\n\n`;

    // Ø¬Ù…Ù„Ø© ØªØ­ÙÙŠØ²ÙŠØ©
    const motivational = [
        'ÙƒÙ„ Ø³Ø¤Ø§Ù„ ØªØ­Ù„Ù‡ Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ø®Ø·ÙˆØ© Ù†Ø­Ùˆ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù„ÙŠ ØªØ­Ù„Ù… ÙÙŠÙ‡Ø§ ğŸ¯',
        'Ø§Ù„Ù†Ø¬Ø§Ø­ ÙÙŠ Ù‚ÙŠØ§Ø³ Ù…Ùˆ Ø­Ø¸ØŒ Ù‡Ùˆ ØªØ±Ø§ÙƒÙ… Ø¬Ù‡Ø¯ Ù…ØªÙˆØ§ØµÙ„ â€” ÙˆØ£Ù†Øª Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚ Ø§Ù„ØµØ­ ğŸ’«',
        'Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø£ÙŠÙ† Ø£Ù†Øª ÙˆØ£ÙŠÙ† ØªØ±ÙŠØ¯ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ùˆ Ù…Ø§ Ø³ØªÙØ¹Ù„Ù‡ Ø§Ù„ÙŠÙˆÙ… ğŸš€',
        'ÙƒÙ„ ÙŠÙˆÙ… ØªØ¯Ø±Ø¨ ÙÙŠÙ‡ Ù‡Ùˆ ÙŠÙˆÙ… ØªÙ‚Ø¯Ù…Øª ÙÙŠÙ‡. Ø§Ø³ØªÙ…Ø±! ğŸŒŸ'
    ];
    report += motivational[Math.floor(Math.random() * motivational.length)];

    return report;
}

function loadStats() {
    const { data: { session } } = await sb.auth.getSession();
    if (!session) { window.location.href = 'login.html'; return; }

    const userId = session.user.id;

    // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„
    const { data: attempts } = await sb.from('attempts')
        .select('*, questions(section, topic)')
        .eq('user_id', userId)
        .order('answered_at', { ascending: false });

    if (!attempts || attempts.length === 0) {
        document.getElementById('loadingState').innerHTML = `
            <div class="text-white/40 text-center py-20">
                <div class="text-5xl mb-4">ğŸ“­</div>
                <div class="text-lg">Ù…Ø§ Ø­Ù„ÙŠØª Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯!</div>
                <a href="select-section.html" class="mt-4 inline-block bg-purple-600 text-white px-6 py-2 rounded-full text-sm">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ¯Ø±ÙŠØ¨</a>
            </div>`;
        return;
    }

    allData = attempts;
    renderStats(attempts);

    document.getElementById('loadingState').classList.add('hidden');
    document.getElementById('statsContent').classList.remove('hidden');
}

function renderStats(data) {
    // Summary
    const total = data.length;
    const correct = data.filter(a => a.is_correct).length;
    const accuracy = total > 0 ? Math.round(correct / total * 100) : 0;

    document.getElementById('totalAnswered').textContent = total.toLocaleString('ar');
    document.getElementById('overallAccuracy').textContent = accuracy + '%';

    // Ø­Ø³Ø§Ø¨ Ø£Ø¯Ø§Ø¡ ÙƒÙ„ Ù…ÙˆØ¶ÙˆØ¹
    const topicStats = {};
    data.forEach(a => {
        if (!a.questions) return;
        const key = `${a.questions.section}__${a.questions.topic}`;
        if (!topicStats[key]) topicStats[key] = { total: 0, correct: 0, section: a.questions.section, topic: a.questions.topic };
        topicStats[key].total++;
        if (a.is_correct) topicStats[key].correct++;
    });

    // Ø£Ù‚ÙˆÙ‰ ÙˆØ£Ø¶Ø¹Ù Ù…ÙˆØ¶ÙˆØ¹
    const topicArr = Object.values(topicStats).filter(t => t.total >= 3);
    if (topicArr.length > 0) {
        topicArr.sort((a, b) => (b.correct/b.total) - (a.correct/a.total));
        const best = topicArr[0];
        const worst = topicArr[topicArr.length - 1];
        document.getElementById('bestTopic').textContent = topicIcons[best.topic] || 'â­';
        document.getElementById('bestTopic').parentElement.querySelector('.text-white\\/50').textContent = topicNames[best.topic] || best.topic;
        document.getElementById('weakestTopic').textContent = topicIcons[worst.topic] || 'âš ï¸';
        document.getElementById('weakestTopic').parentElement.querySelector('.text-white\\/50').textContent = topicNames[worst.topic] || worst.topic;
    }

    renderTopicsGrid(topicStats);
    renderRecentActivity(data.slice(0, 10));
}

function renderTopicsGrid(topicStats) {
    const grid = document.getElementById('topicsGrid');
    grid.innerHTML = '';

    // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±
    const filtered = Object.values(topicStats).filter(t =>
        currentSection === 'all' || t.section === currentSection
    );

    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­
    filtered.sort((a, b) => {
        const aRate = a.total > 0 ? a.correct / a.total : 0;
        const bRate = b.total > 0 ? b.correct / b.total : 0;
        return bRate - aRate;
    });

    if (filtered.length === 0) {
        grid.innerHTML = '<div class="text-white/40 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯</div>';
        return;
    }

    // ØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…
    const sections = [...new Set(filtered.map(t => t.section))];
    sections.forEach(section => {
        const sectionTopics = filtered.filter(t => t.section === section);
        if (sectionTopics.length === 0) return;

        if (currentSection === 'all') {
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'text-white/50 text-sm font-bold pt-2';
            sectionHeader.textContent = `â€” ${sectionNames[section] || section} â€”`;
            grid.appendChild(sectionHeader);
        }

        sectionTopics.forEach((t, i) => {
            const accuracy = t.total > 0 ? Math.round(t.correct / t.total * 100) : 0;
            const color = accuracy >= 75 ? '#22c55e' : accuracy >= 50 ? '#f59e0b' : '#ef4444';
            const label = accuracy >= 75 ? 'âœ… Ù…Ù…ØªØ§Ø²' : accuracy >= 50 ? 'âš¡ Ù…ØªÙˆØ³Ø·' : 'âš ï¸ ÙŠØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©';

            const card = document.createElement('div');
            card.className = 'topic-card glass rounded-xl p-4';
            card.style.animationDelay = `${i * 0.05}s`;
            card.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${topicIcons[t.topic] || 'ğŸ“Œ'}</span>
                        <div>
                            <div class="text-white font-bold">${topicNames[t.topic] || t.topic}</div>
                            <div class="text-white/40 text-xs">${t.total} Ø³Ø¤Ø§Ù„</div>
                        </div>
                    </div>
                    <div class="text-left">
                        <div class="font-black text-xl" style="color:${color}">${accuracy}%</div>
                        <div class="text-xs" style="color:${color}">${label}</div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width:${accuracy}%; background: linear-gradient(90deg, ${color}99, ${color})"></div>
                </div>
                <div class="flex justify-between mt-2 text-xs text-white/40">
                    <span>âœ… ${t.correct} ØµØ­</span>
                    <span>âŒ ${t.total - t.correct} Ø®Ø·Ø£</span>
                </div>
            `;
            grid.appendChild(card);
        });
    });
}

function renderRecentActivity(data) {
    const container = document.getElementById('recentActivity');
    container.innerHTML = '';

    const sectionEmojis = { quant: 'âš¡', verbal: 'ğŸ“–', tahsili: 'ğŸ“' };

    data.forEach(a => {
        if (!a.questions) return;
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between py-2 border-b border-white/5';
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <span>${a.is_correct ? 'âœ…' : 'âŒ'}</span>
                <span class="text-xs text-white/50">${sectionEmojis[a.questions.section] || ''} ${topicNames[a.questions.topic] || a.questions.topic || 'â€”'}</span>
            </div>
            <span class="text-white/30 text-xs">${formatDate(a.answered_at)}</span>
        `;
        container.appendChild(div);
    });
}

function showSection(section) {
    currentSection = section;
    document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`tab-${section}`).classList.add('active');

    const topicStats = {};
    allData.forEach(a => {
        if (!a.questions) return;
        const key = `${a.questions.section}__${a.questions.topic}`;
        if (!topicStats[key]) topicStats[key] = { total: 0, correct: 0, section: a.questions.section, topic: a.questions.topic };
        topicStats[key].total++;
        if (a.is_correct) topicStats[key].correct++;
    });
    renderTopicsGrid(topicStats);
}

async function generateAIReport() {
    const btn = document.getElementById('aiBtn');
    btn.disabled = true;
    btn.textContent = 'â³ ÙŠØ­Ù„Ù„...';

    const section = document.getElementById('aiReportSection');
    const content = document.getElementById('aiReportContent');
    section.classList.remove('hidden');
    content.textContent = 'Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ±Ùƒ Ø§Ù„Ø´Ø®ØµÙŠ...';
    section.scrollIntoView({ behavior: 'smooth' });

    // ØªØ¬Ù…ÙŠØ¹ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡
    const topicStats = {};
    allData.forEach(a => {
        if (!a.questions) return;
        const key = a.questions.topic || 'unknown';
        if (!topicStats[key]) topicStats[key] = { total: 0, correct: 0, section: a.questions.section };
        topicStats[key].total++;
        if (a.is_correct) topicStats[key].correct++;
    });

    const summary = Object.entries(topicStats).map(([topic, s]) => {
        const acc = Math.round(s.correct / s.total * 100);
        return `${topicNames[topic] || topic} (${s.section}): ${s.correct}/${s.total} ØµØ­ = ${acc}%`;
    }).join('\n');

    const total = allData.length;
    const correct = allData.filter(a => a.is_correct).length;
    const overall = Math.round(correct / total * 100);

    const prompt = `Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù‚ÙŠØ§Ø³ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© (Ù‚Ø¯Ø±Ø§Øª ÙˆØªØ­ØµÙŠÙ„).

Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©: ${total}
- Ù†Ø³Ø¨Ø© Ø§Ù„ØµØ­ Ø§Ù„ÙƒÙ„ÙŠØ©: ${overall}%

ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:
${summary}

Ø§ÙƒØªØ¨ ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ø´Ø®ØµÙŠØ§Ù‹ Ù…Ø®ØªØµØ±Ø§Ù‹ (10-15 Ø³Ø·Ø±) Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙŠØªØ¶Ù…Ù†:
1. ØªÙ‚ÙŠÙŠÙ… Ø¹Ø§Ù… Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø·Ø§Ù„Ø¨
2. Ø£Ø¨Ø±Ø² Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© (Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ 70%)
3. Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ù„Ø­Ø§Ø­Ø§Ù‹ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© (Ø£Ù‚Ù„ Ù…Ù† 50%)
4. Ø®Ø·Ø© Ø¹Ù…Ù„ÙŠØ© Ù…Ø®ØªØµØ±Ø© (3 Ø®Ø·ÙˆØ§Øª)
5. Ø¬Ù…Ù„Ø© ØªØ­ÙÙŠØ²ÙŠØ© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©

Ø§Ø³ØªØ®Ø¯Ù… Ø£Ø³Ù„ÙˆØ¨Ø§Ù‹ ÙˆØ¯ÙŠØ§Ù‹ ÙˆØ¯Ø§Ø¹Ù…Ø§Ù‹ Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ù‚Ø©.`;

    try {
        const report = generateLocalReport(topicStats, total, overall);
        // Ø¹Ø±Ø¶ ØªØ¯Ø±ÙŠØ¬ÙŠ Ù„Ù„Ù†Øµ
        content.textContent = '';
        let i = 0;
        const words = report.split(' ');
        const interval = setInterval(() => {
            if (i < words.length) {
                content.textContent += (i > 0 ? ' ' : '') + words[i];
                i++;
            } else {
                clearInterval(interval);
            }
        }, 30);
    } catch (e) {
        content.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±.';
    }

    btn.disabled = false;
    btn.innerHTML = '<span>âœ¨</span> ØªÙ‚Ø±ÙŠØ± Ø°ÙƒÙŠ';
}

function formatDate(dateStr) {
    const d = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - d) / 1000);
    if (diff < 60) return 'Ø§Ù„Ø¢Ù†';
    if (diff < 3600) return `${Math.floor(diff/60)} Ø¯`;
    if (diff < 86400) return `${Math.floor(diff/3600)} Ø³`;
    return `${Math.floor(diff/86400)} ÙŠ`;
}

loadStats();
</script>
</body>
</html>
