<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© - Ù…Ø³Ø§Ø±ÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        *{font-family:'Tajawal',sans-serif}
        body{background:linear-gradient(135deg,#0f0a2e 0%,#1a1145 30%,#1e1550 50%,#151040 70%,#0d0825 100%);min-height:100vh}
        .glass{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);backdrop-filter:blur(20px);border-radius:1rem}
        .sidebar{background:rgba(255,255,255,0.03);border-left:1px solid rgba(255,255,255,0.06);min-height:100vh;width:240px;position:fixed;top:0;right:0;z-index:40;overflow-y:auto}
        .sb-link{display:flex;align-items:center;gap:12px;padding:12px 18px;border-radius:.75rem;font-size:.9rem;font-weight:700;color:rgba(196,181,253,0.5);transition:all .2s;cursor:pointer;margin:3px 10px}
        .sb-link:hover{background:rgba(255,255,255,0.05);color:rgba(196,181,253,0.8)}
        .sb-link.on{background:rgba(99,102,241,0.15);color:#a5b4fc;border:1px solid rgba(99,102,241,0.2)}
        .mc{margin-right:240px;padding:28px;min-height:100vh}
        .inp{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:.75rem;padding:.75rem 1rem;color:#fff;width:100%;font-size:.95rem;transition:all .2s}
        .inp:focus{outline:none;border-color:rgba(139,92,246,0.5);box-shadow:0 0 0 3px rgba(139,92,246,0.1)}
        .inp::placeholder{color:rgba(255,255,255,0.2)}
        .inp option{background:#1a1145;color:#fff}
        .bp{background:linear-gradient(135deg,#6366f1,#8b5cf6);padding:10px 24px;border-radius:.75rem;font-weight:700;font-size:.9rem;color:#fff;transition:all .2s;border:none;cursor:pointer}
        .bp:hover{box-shadow:0 8px 25px rgba(99,102,241,0.3);transform:translateY(-1px)}
        .bd{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.2);color:#f87171;padding:8px 16px;border-radius:.75rem;font-size:.85rem;font-weight:600;cursor:pointer}
        .bs{background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#c4b5fd;padding:8px 16px;border-radius:.75rem;font-size:.85rem;font-weight:600;cursor:pointer}
        .sc{transition:all .3s}.sc:hover{transform:translateY(-3px)}
        .tr{border-bottom:1px solid rgba(255,255,255,0.04)}.tr:hover{background:rgba(255,255,255,0.03)}
        .bg{display:inline-block;padding:3px 12px;border-radius:999px;font-size:.8rem;font-weight:700}
        .bg-f{background:rgba(251,191,36,0.1);color:#fbbf24;border:1px solid rgba(251,191,36,0.2)}
        .bg-m{background:rgba(99,102,241,0.1);color:#818cf8;border:1px solid rgba(99,102,241,0.2)}
        .bg-y{background:rgba(16,185,129,0.1);color:#34d399;border:1px solid rgba(16,185,129,0.2)}
        .bg-a{background:rgba(239,68,68,0.1);color:#f87171;border:1px solid rgba(239,68,68,0.2)}
        .tab{display:none}.tab.on{display:block}
        .toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);padding:12px 28px;border-radius:12px;font-size:.95rem;font-weight:700;z-index:999;animation:sd .4s ease}
        .tok{background:linear-gradient(135deg,#10b981,#14b8a6);color:#fff}
        .ter{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
        @keyframes sd{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
        .mbg{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(5px);z-index:50;display:flex;align-items:center;justify-content:center;padding:16px}
        .mbox{background:linear-gradient(135deg,#1a1145,#1e1550);border:1px solid rgba(139,92,246,0.2);border-radius:1.25rem;padding:28px;width:100%;max-width:540px;max-height:85vh;overflow-y:auto}
        .rr{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:.75rem}.rr:hover{background:rgba(255,255,255,0.03)}
        .rn{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:.8rem;flex-shrink:0}
        @media(max-width:768px){.sidebar{display:none}.mc{margin-right:0;padding:16px}}
    </style>
</head>
<body class="text-white">
<div id="toast" class="toast hidden"></div>

<!-- Sidebar -->
<aside class="sidebar">
    <div class="p-4 mb-2"><div class="flex items-center gap-2 mb-1"><span class="text-xl">ğŸ“</span><span class="text-lg font-black bg-gradient-to-l from-purple-300 to-indigo-300 bg-clip-text text-transparent">Ù…Ø³Ø§Ø±ÙŠ</span></div><p class="text-[10px] text-purple-300/30">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p></div>
    <div class="sb-link on" data-tab="overview"><span>ğŸ“Š</span><span>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</span></div>
    <div class="sb-link" data-tab="questions"><span>ğŸ“</span><span>Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</span></div>
    <div class="sb-link" data-tab="users"><span>ğŸ‘¥</span><span>Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</span></div>
    <div class="sb-link" data-tab="coupons"><span>ğŸŸï¸</span><span>Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</span></div>
    <div class="sb-link" data-tab="finance"><span>ğŸ’°</span><span>Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span></div>
    <div class="sb-link" data-tab="reports"><span>ğŸš©</span><span>Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</span></div>
    <div class="sb-link" data-tab="staff"><span>ğŸ”‘</span><span>Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</span></div>
    <div class="sb-link" data-tab="settings"><span>âš™ï¸</span><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></div>
    <div class="mt-4 p-4 border-t border-purple-500/10"><div class="sb-link" onclick="sb.auth.signOut().then(function(){location.href='login.html'})" style="color:#f87171"><span>ğŸšª</span><span>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span></div></div>
</aside>

<!-- Main -->
<div class="mc">

<!-- â•â•â• Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© â•â•â• -->
<div id="t-overview" class="tab on">
    <h2 class="text-2xl font-black mb-6">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</p><p class="text-4xl font-black text-indigo-400" id="s-q">-</p></div>
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</p><p class="text-4xl font-black text-emerald-400" id="s-u">-</p></div>
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</p><p class="text-4xl font-black text-purple-400" id="s-a">-</p></div>
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</p><p class="text-4xl font-black text-red-400" id="s-r">-</p></div>
    </div>
    <div class="grid lg:grid-cols-2 gap-4 mb-6">
        <div class="glass p-6"><h3 class="font-bold text-base mb-4">ğŸ“ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù…</h3><div id="d-sec" class="space-y-3"></div></div>
        <div class="glass p-6"><h3 class="font-bold text-base mb-4">ğŸ”¥ Ø£ÙƒØ«Ø± Ø³Ø¤Ø§Ù„ ÙŠØºÙ„Ø·ÙˆÙ† ÙÙŠÙ‡</h3><div id="d-hard" class="text-purple-300/50">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
    <div class="grid lg:grid-cols-3 gap-4 mb-6">
        <div class="glass p-6"><h3 class="font-bold text-base mb-4">ğŸ† Ø£ÙƒØ«Ø± Ø­Ù„ÙˆÙ„Ø§Ù‹</h3><div id="d-top"></div></div>
        <div class="glass p-6"><h3 class="font-bold text-base mb-4">ğŸ¯ Ø£Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© ØµØ­</h3><div id="d-acc"></div></div>
        <div class="glass p-6"><h3 class="font-bold text-base mb-4">âš¡ Ø£Ù†Ø´Ø· (Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…)</h3><div id="d-act"></div></div>
    </div>
    <div class="grid lg:grid-cols-2 gap-4">
        <div class="glass p-6 text-center"><h3 class="font-bold text-base mb-4">ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ø§Ù…Ø©</h3><p class="text-5xl font-black text-emerald-400" id="d-rate">-</p><p class="text-purple-300/40 text-sm mt-1">Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª</p></div>
        <div class="glass p-6"><h3 class="font-bold text-base mb-4">ğŸ†• Ø£Ø­Ø¯Ø« Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3><div id="d-new"></div></div>
    </div>
</div>

<!-- â•â•â• Ø§Ù„Ø£Ø³Ø¦Ù„Ø© â•â•â• -->
<div id="t-questions" class="tab">
    <div class="flex items-center justify-between mb-5"><h2 class="text-2xl font-black">ğŸ“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h2><button class="bp" onclick="openQM()">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button></div>
    <div class="flex gap-2 mb-4">
        <select id="qf" class="inp" style="max-width:160px" onchange="loadQ()"><option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</option><option value="quant">ÙƒÙ…ÙŠ</option><option value="verbal">Ù„ÙØ¸ÙŠ</option><option value="tahsili">ØªØ­ØµÙŠÙ„ÙŠ</option></select>
        <input type="text" id="qs" class="inp" placeholder="Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©..." oninput="loadQ()">
    </div>
    <div id="q-list" class="space-y-2"></div>
</div>

<!-- â•â•â• Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ â•â•â• -->
<div id="t-users" class="tab">
    <h2 class="text-2xl font-black mb-5">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h2>
    <input type="text" id="us" class="inp mb-4" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„..." oninput="loadU()">
    <div class="glass overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-purple-500/10"><th class="text-right p-3 text-purple-300/50 text-sm">Ø§Ù„Ø¹Ø¶Ùˆ</th><th class="text-right p-3 text-purple-300/50 text-sm">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th class="text-center p-3 text-purple-300/50 text-sm">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th><th class="text-center p-3 text-purple-300/50 text-sm">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th><th class="text-center p-3 text-purple-300/50 text-sm">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="u-list"></tbody></table></div>
</div>

<!-- â•â•â• Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª â•â•â• -->
<div id="t-coupons" class="tab">
    <div class="flex items-center justify-between mb-5"><h2 class="text-2xl font-black">ğŸŸï¸ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</h2><button class="bp" onclick="$('couponM').classList.remove('hidden')">+ ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</button></div>
    <div class="glass overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-purple-500/10"><th class="text-right p-3 text-purple-300/50">Ø§Ù„ÙƒÙˆØ¯</th><th class="text-center p-3 text-purple-300/50">Ø§Ù„Ø®ØµÙ…</th><th class="text-center p-3 text-purple-300/50">ÙŠØ·Ø¨Ù‘Ù‚ Ø¹Ù„Ù‰</th><th class="text-center p-3 text-purple-300/50">Ø§Ù„Ù…Ø¯Ø©</th><th class="text-center p-3 text-purple-300/50">Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</th><th class="text-center p-3 text-purple-300/50">Ø§Ù„Ø­Ø§Ù„Ø©</th><th class="text-center p-3 text-purple-300/50">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="c-list"></tbody></table></div>
</div>

<!-- â•â•â• Ø§Ù„Ù…Ø§Ù„ÙŠØ© â•â•â• -->
<div id="t-finance" class="tab">
    <h2 class="text-2xl font-black mb-5">ğŸ’° Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ù…Ø´ØªØ±ÙƒÙŠÙ† ÙØ¹Ø§Ù„ÙŠÙ†</p><p class="text-4xl font-black text-emerald-400" id="f-a">-</p></div>
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ø´Ù‡Ø±ÙŠ</p><p class="text-4xl font-black text-indigo-400" id="f-m">-</p></div>
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ø³Ù†ÙˆÙŠ</p><p class="text-4xl font-black text-purple-400" id="f-y">-</p></div>
        <div class="sc glass p-5 text-center"><p class="text-purple-300/50 text-sm mb-1">Ù…Ø¬Ø§Ù†ÙŠ</p><p class="text-4xl font-black text-yellow-400" id="f-f">-</p></div>
    </div>
</div>

<!-- â•â•â• Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª â•â•â• -->
<div id="t-reports" class="tab"><h2 class="text-2xl font-black mb-5">ğŸš© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h2><div id="r-list" class="space-y-2"></div></div>

<!-- â•â•â• Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† â•â•â• -->
<div id="t-staff" class="tab">
    <div class="flex items-center justify-between mb-5"><h2 class="text-2xl font-black">ğŸ”‘ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h2><button class="bp" onclick="$('staffM').classList.remove('hidden')">+ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button></div>
    <div class="glass overflow-x-auto"><table class="w-full text-sm"><thead><tr class="border-b border-purple-500/10"><th class="text-right p-3 text-purple-300/50">Ø§Ù„Ø§Ø³Ù…</th><th class="text-right p-3 text-purple-300/50">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</th><th class="text-center p-3 text-purple-300/50">Ø§Ù„Ø¯ÙˆØ±</th><th class="text-center p-3 text-purple-300/50">Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="st-list"></tbody></table></div>
</div>

<!-- â•â•â• Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª â•â•â• -->
<div id="t-settings" class="tab">
    <h2 class="text-2xl font-black mb-5">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
    <div class="glass p-6 mb-4"><h3 class="font-bold text-base mb-3">ğŸ“¢ Ù†Øµ Ø§Ù„Ø¨Ø§Ù†Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠ</h3><textarea id="st-ban" class="inp" rows="2"></textarea><button class="bp mt-2" onclick="saveSt('banner_text',$('st-ban').value)">Ø­ÙØ¸</button></div>
    <div class="glass p-6 mb-4">
        <h3 class="font-bold text-base mb-4">ğŸ’° Ø§Ù„Ø£Ø³Ø¹Ø§Ø± ÙˆØ§Ù„Ø®ØµÙˆÙ…Ø§Øª</h3>
        <p class="text-purple-300/30 text-xs mb-4">Ø­Ø· Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ ÙˆØ§Ù„Ø­Ø§Ù„ÙŠ â€” Ù„Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£Ù‚Ù„ Ø¨ÙŠØ¸Ù‡Ø± Ø®Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£ØµÙ„ÙŠ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</p>
        <div class="mb-4 p-4 rounded-xl" style="background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.1)"><p class="text-indigo-400 font-bold text-sm mb-2">ğŸ“… Ø§Ù„Ø´Ù‡Ø±ÙŠ</p><div class="grid grid-cols-2 gap-3"><div><label class="text-purple-300/40 text-xs mb-1 block">Ø§Ù„Ø£ØµÙ„ÙŠ</label><input type="number" id="st-mo" class="inp" value="39"></div><div><label class="text-purple-300/40 text-xs mb-1 block">Ø§Ù„Ø­Ø§Ù„ÙŠ</label><input type="number" id="st-m" class="inp" value="29"></div></div></div>
        <div class="mb-4 p-4 rounded-xl" style="background:rgba(16,185,129,0.06);border:1px solid rgba(16,185,129,0.1)"><p class="text-emerald-400 font-bold text-sm mb-2">ğŸ’ Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø³Ù†Ø©)</p><div class="grid grid-cols-2 gap-3"><div><label class="text-purple-300/40 text-xs mb-1 block">Ø§Ù„Ø£ØµÙ„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø±ÙŠØ§Ù„)</label><input type="number" id="st-yo" class="inp" value="348"></div><div><label class="text-purple-300/40 text-xs mb-1 block">Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø±ÙŠØ§Ù„)</label><input type="number" id="st-y" class="inp" value="228"></div></div><p class="text-purple-300/20 text-xs mt-2">* Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø´Ù‡Ø±ÙŠ ÙŠØªØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ (Ã·12)</p></div>
        <button class="bp" onclick="savePrice()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
    </div>
    <div class="glass p-6 mb-4"><h3 class="font-bold text-base mb-3">ğŸ†“ Ø­Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</h3><input type="number" id="st-fl" class="inp" value="10" style="max-width:120px"><button class="bp mt-2" onclick="saveSt('free_limit',$('st-fl').value)">Ø­ÙØ¸</button></div>
</div>

</div><!-- end mc -->

<!-- â•â•â• Question Modal â•â•â• -->
<div id="questionM" class="mbg hidden"><div class="mbox">
    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg" id="qmT">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h3><button onclick="$('questionM').classList.add('hidden')" class="text-purple-300/30 hover:text-white text-lg">âœ•</button></div>
    <input type="hidden" id="qm-id">
    <div class="space-y-3">
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label><select id="qm-sec" class="inp" onchange="updateSubSec()"><option value="quant">Ù‚Ø¯Ø±Ø§Øª ÙƒÙ…ÙŠ</option><option value="verbal">Ù‚Ø¯Ø±Ø§Øª Ù„ÙØ¸ÙŠ</option><option value="tahsili">Ø§Ù„ØªØ­ØµÙŠÙ„ÙŠ</option></select></div>
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙØ±Ø¹ÙŠ</label><select id="qm-sub" class="inp"></select></div>

        <!-- ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ -->
        <div class="p-4 rounded-xl" style="background:rgba(99,102,241,0.05);border:1px solid rgba(99,102,241,0.1)">
            <label class="text-purple-300/50 text-sm mb-2 block">ğŸ–¼ï¸ ØµÙˆØ±Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <p class="text-purple-300/30 text-xs mb-2">Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ Ø­Ø· Ø±Ø§Ø¨Ø· â€” Ø§Ù„ØµÙˆØ±Ø© ØªØ¸Ù‡Ø± ÙÙˆÙ‚ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</p>
            <input type="file" id="qm-file" accept="image/*" class="inp text-sm mb-2" onchange="previewImg(this)">
            <input id="qm-img" class="inp text-sm" placeholder="Ø£Ùˆ Ø­Ø· Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§...">
            <div id="qm-preview" class="mt-2 hidden"><img id="qm-prev-img" class="max-h-32 rounded-lg mx-auto"><button onclick="clearImg()" class="text-red-400 text-xs mt-1 block mx-auto">âœ• Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØµÙˆØ±Ø©</button></div>
        </div>

        <div><label class="text-purple-300/50 text-sm mb-1 block">Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label><textarea id="qm-txt" class="inp" rows="3" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„... Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº Ù„Ùˆ Ø§Ù„Ø³Ø¤Ø§Ù„ ØµÙˆØ±Ø© ÙÙ‚Ø·"></textarea></div>
        <div class="grid grid-cols-2 gap-2"><div><label class="text-purple-300/50 text-xs mb-1 block">Ø®ÙŠØ§Ø± 1</label><input id="qm-c0" class="inp"></div><div><label class="text-purple-300/50 text-xs mb-1 block">Ø®ÙŠØ§Ø± 2</label><input id="qm-c1" class="inp"></div><div><label class="text-purple-300/50 text-xs mb-1 block">Ø®ÙŠØ§Ø± 3</label><input id="qm-c2" class="inp"></div><div><label class="text-purple-300/50 text-xs mb-1 block">Ø®ÙŠØ§Ø± 4</label><input id="qm-c3" class="inp"></div></div>
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</label><select id="qm-cor" class="inp"><option value="0">Ø®ÙŠØ§Ø± 1</option><option value="1">Ø®ÙŠØ§Ø± 2</option><option value="2">Ø®ÙŠØ§Ø± 3</option><option value="3">Ø®ÙŠØ§Ø± 4</option></select></div>
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ø´Ø±Ø­</label><textarea id="qm-exp" class="inp" rows="3"></textarea></div>
        <button class="bp w-full" onclick="saveQ2()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
    </div>
</div></div>

<!-- â•â•â• User Modal â•â•â• -->
<div id="userM" class="mbg hidden"><div class="mbox">
    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ</h3><button onclick="$('userM').classList.add('hidden')" class="text-purple-300/30 hover:text-white text-lg">âœ•</button></div>
    <input type="hidden" id="um-id">
    <div class="space-y-3"><div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ø§Ø³Ù…</label><input id="um-n" class="inp"></div><div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label><input id="um-e" class="inp" disabled></div><div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</label><select id="um-s" class="inp"><option value="free">Ù…Ø¬Ø§Ù†ÙŠ</option><option value="monthly">Ø´Ù‡Ø±ÙŠ</option><option value="yearly">Ø³Ù†ÙˆÙŠ</option></select></div><div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ø¯ÙˆØ±</label><select id="um-r" class="inp"><option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option><option value="admin">Ø£Ø¯Ù…Ù†</option></select></div><button class="bp w-full" onclick="saveU2()">ğŸ’¾ Ø­ÙØ¸</button></div>
</div></div>

<!-- â•â•â• Coupon Modal â•â•â• -->
<div id="couponM" class="mbg hidden"><div class="mbox">
    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">ÙƒÙˆØ¨ÙˆÙ† Ø¬Ø¯ÙŠØ¯</h3><button onclick="$('couponM').classList.add('hidden')" class="text-purple-300/30 hover:text-white text-lg">âœ•</button></div>
    <div class="space-y-3">
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„ÙƒÙˆØ¯</label><input id="cm-c" class="inp" style="text-transform:uppercase" placeholder="Ù…Ø«Ø§Ù„: MASARI50"></div>
        <div><label class="text-purple-300/50 text-sm mb-1 block">ÙŠØ·Ø¨Ù‘Ù‚ Ø¹Ù„Ù‰</label><select id="cm-plan" class="inp"><option value="all">Ø§Ù„ÙƒÙ„ (Ø´Ù‡Ø±ÙŠ + Ø³Ù†ÙˆÙŠ)</option><option value="monthly">Ø´Ù‡Ø±ÙŠ ÙÙ‚Ø·</option><option value="yearly">Ø³Ù†ÙˆÙŠ ÙÙ‚Ø·</option></select></div>
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ù†ÙˆØ¹ Ø§Ù„Ø®ØµÙ…</label><select id="cm-t" class="inp"><option value="percentage">Ù†Ø³Ø¨Ø© %</option><option value="fixed">Ù…Ø¨Ù„Øº Ø«Ø§Ø¨Øª (Ø±ÙŠØ§Ù„)</option></select></div>
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ù‚ÙŠÙ…Ø©</label><input type="number" id="cm-v" class="inp" placeholder="Ù…Ø«Ø§Ù„: 50"></div>
        <div><label class="text-purple-300/50 text-sm mb-1 block">Ù…Ø¯Ø© Ø§Ù„ÙƒÙˆØ¨ÙˆÙ† (Ø§Ø´ØªØ±Ø§Ùƒ ÙŠÙØ¹Ù‘Ù„ Ù„ÙƒÙ… Ø´Ù‡Ø±)</label><select id="cm-dur" class="inp"><option value="1">Ø´Ù‡Ø± ÙˆØ§Ø­Ø¯</option><option value="3">3 Ø£Ø´Ù‡Ø±</option><option value="6">6 Ø£Ø´Ù‡Ø±</option><option value="12" selected>Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</option></select></div>
        <div class="grid grid-cols-2 gap-3">
            <div><label class="text-purple-300/50 text-sm mb-1 block">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</label><input type="number" id="cm-x" class="inp" value="100"></div>
            <div><label class="text-purple-300/50 text-sm mb-1 block">ÙŠÙ†ØªÙ‡ÙŠ Ø¨ØªØ§Ø±ÙŠØ®</label><input type="date" id="cm-e" class="inp"></div>
        </div>
        <button class="bp w-full" onclick="saveC2()">ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†</button>
    </div>
</div></div>

<!-- â•â•â• Staff Modal â•â•â• -->
<div id="staffM" class="mbg hidden"><div class="mbox">
    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h3><button onclick="$('staffM').classList.add('hidden')" class="text-purple-300/30 hover:text-white text-lg">âœ•</button></div>
    <div class="space-y-3"><div><label class="text-purple-300/50 text-sm mb-1 block">Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù</label><input id="sm-e" class="inp"></div><button class="bp w-full" onclick="saveSt2()">ğŸ’¾ Ø¥Ø¶Ø§ÙØ© ÙƒØ£Ø¯Ù…Ù†</button></div>
</div></div>
<!-- â•â•â• Preview Modal â•â•â• -->
<div id="previewM" class="mbg hidden"><div class="mbox" style="max-width:420px">
    <div class="flex items-center justify-between mb-4"><h3 class="font-bold text-lg">ğŸ‘ï¸ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ø¤Ø§Ù„</h3><button onclick="$('previewM').classList.add('hidden')" class="text-purple-300/30 hover:text-white text-lg">âœ•</button></div>
    <div id="pv-body" class="space-y-3"></div>
</div></div>

</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
var sb=window.supabase.createClient('https://czzcmbxejxbotjemyuqf.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN6emNtYnhlanhib3RqZW15dXFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNzQ0ODEsImV4cCI6MjA4NTc1MDQ4MX0.xDfG1qsDZGyUrpL44JfqOtk57dVsLaMsvIzJz1KgiR0');
var me=null;
function $(id){return document.getElementById(id)}

// Sub-sections map
var subSections={
    quant:['Ø§Ù„Ø¬Ø¨Ø± ÙˆØ§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø§Øª','Ø§Ù„Ù†Ø³Ø¨Ø© ÙˆØ§Ù„ØªÙ†Ø§Ø³Ø¨','Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©','Ø§Ù„Ø¥Ø­ØµØ§Ø¡','Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯','Ø§Ù„ØªØ­Ù„ÙŠÙ„'],
    verbal:['Ø§Ù„ØªÙ†Ø§Ø¸Ø± Ø§Ù„Ù„ÙØ¸ÙŠ','Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¬Ù…Ù„','Ø§Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„Ù…Ù‚Ø±ÙˆØ¡','Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø³ÙŠØ§Ù‚ÙŠ'],
    tahsili:['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª','Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡','Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡','Ø§Ù„Ø£Ø­ÙŠØ§Ø¡','Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©']
};
function updateSubSec(){
    var sec=$('qm-sec').value;var opts=subSections[sec]||[];
    $('qm-sub').innerHTML=opts.map(function(o){return'<option value="'+o+'">'+o+'</option>'}).join('');
}

// Auth
async function init(){
    var{data:{session}}=await sb.auth.getSession();
    if(!session){location.href='admin-login.html';return}
    var{data:p}=await sb.from('profiles').select('role,full_name').eq('id',session.user.id).single();
    if(!p||p.role!=='admin'){location.href='admin-login.html';return}
    me={id:session.user.id,...p};loadOV();
}

// Tabs
document.querySelectorAll('.sb-link[data-tab]').forEach(function(el){
    el.addEventListener('click',function(){
        var t=this.dataset.tab;
        document.querySelectorAll('.tab').forEach(function(s){s.classList.remove('on')});
        document.querySelectorAll('.sb-link').forEach(function(l){l.classList.remove('on')});
        $('t-'+t).classList.add('on');this.classList.add('on');
        if(t==='overview')loadOV();if(t==='questions')loadQ();if(t==='users')loadU();
        if(t==='coupons')loadC();if(t==='finance')loadF();if(t==='reports')loadR();
        if(t==='staff')loadST();if(t==='settings')loadSet();
    });
});

function toast(m,ok){var t=$('toast');t.textContent=m;t.className='toast '+(ok?'tok':'ter');setTimeout(function(){t.classList.add('hidden')},3000)}

// â•â•â• OVERVIEW â•â•â•
async function loadOV(){
    var{data:q}=await sb.from('questions').select('section,sub_section');
    var{data:u}=await sb.from('profiles').select('id,full_name,email,avatar_emoji,created_at');
    var{data:a}=await sb.from('attempts').select('id,user_id,is_correct,question_id,created_at');
    var{data:r}=await sb.from('reports').select('id');
    $('s-q').textContent=q?q.length:0;$('s-u').textContent=u?u.length:0;
    $('s-a').textContent=a?a.length:0;$('s-r').textContent=r?r.length:0;

    if(q){var c={quant:0,verbal:0,tahsili:0};q.forEach(function(x){if(c[x.section]!==undefined)c[x.section]++});
    var nm={quant:'Ù‚Ø¯Ø±Ø§Øª ÙƒÙ…ÙŠ',verbal:'Ù‚Ø¯Ø±Ø§Øª Ù„ÙØ¸ÙŠ',tahsili:'Ø§Ù„ØªØ­ØµÙŠÙ„ÙŠ'},cl={quant:'#6366f1',verbal:'#10b981',tahsili:'#8b5cf6'},tot=q.length||1,h='';
    for(var k in c){var p=Math.round(c[k]/tot*100);h+='<div class="flex items-center justify-between text-sm mb-1"><span class="text-purple-200/70">'+nm[k]+'</span><span class="font-bold text-white">'+c[k]+'</span></div><div class="h-2 rounded-full mb-3" style="background:rgba(255,255,255,0.06)"><div class="h-full rounded-full" style="width:'+p+'%;background:'+cl[k]+'"></div></div>'}
    $('d-sec').innerHTML=h}

    if(!a||!a.length){$('d-hard').innerHTML='<p class="text-purple-300/40">Ù…Ø§ ÙÙŠÙ‡ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¨Ø¹Ø¯</p>';$('d-rate').textContent='-';$('d-top').innerHTML=$('d-acc').innerHTML=$('d-act').innerHTML=$('d-new').innerHTML='<p class="text-purple-300/30">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>';
    if(u&&u.length){var nh='';u.sort(function(a,b){return new Date(b.created_at)-new Date(a.created_at)}).slice(0,5).forEach(function(m){nh+='<div class="rr"><span class="text-lg">'+(m.avatar_emoji||'ğŸ‘¤')+'</span><div class="flex-1"><p class="text-white font-bold text-sm">'+(m.full_name||'â€”')+'</p></div><p class="text-purple-300/30 text-xs">'+(m.created_at?new Date(m.created_at).toLocaleDateString('ar-SA'):'')+'</p></div>'});$('d-new').innerHTML=nh}
    return}

    // Hardest
    var wr=a.filter(function(x){return!x.is_correct}),fr={};
    wr.forEach(function(x){fr[x.question_id]=(fr[x.question_id]||0)+1});
    if(Object.keys(fr).length){var hid=Object.keys(fr).sort(function(a,b){return fr[b]-fr[a]})[0];
    var{data:hq}=await sb.from('questions').select('question_text,section').eq('id',hid).single();
    if(hq){var sn={quant:'ÙƒÙ…ÙŠ',verbal:'Ù„ÙØ¸ÙŠ',tahsili:'ØªØ­ØµÙŠÙ„ÙŠ'};$('d-hard').innerHTML='<span class="bg bg-m mb-2">'+(sn[hq.section]||'')+'</span><p class="text-white text-base mt-2">'+hq.question_text.substring(0,120)+'</p><p class="text-red-400 text-sm mt-2 font-bold">ğŸ”´ '+fr[hid]+' Ø®Ø·Ø£</p>'}}
    else $('d-hard').innerHTML='<p class="text-purple-300/40">Ù…Ø§ ÙÙŠÙ‡ Ø£Ø®Ø·Ø§Ø¡</p>';

    // Rate
    var cor=a.filter(function(x){return x.is_correct}).length;$('d-rate').textContent=Math.round(cor/a.length*100)+'%';

    // User map
    var um={};if(u)u.forEach(function(x){um[x.id]=x});
    var ua={};a.forEach(function(x){if(!ua[x.user_id])ua[x.user_id]={t:0,c:0};ua[x.user_id].t++;if(x.is_correct)ua[x.user_id].c++});
    var rc=['#fbbf24','#c0c0c0','#cd7f32','#818cf8','#818cf8'],rb=['rgba(251,191,36,0.15)','rgba(192,192,192,0.1)','rgba(205,127,50,0.1)','rgba(129,140,248,0.08)','rgba(129,140,248,0.08)'];

    function rank(arr,el,valFn,lblFn){var h='';arr.forEach(function(uid,i){var usr=um[uid]||{};h+='<div class="rr"><div class="rn" style="background:'+rb[i]+';color:'+rc[i]+'">'+(i+1)+'</div><div class="flex-1"><p class="text-white font-bold text-sm">'+(usr.full_name||'Ù…Ø¬Ù‡ÙˆÙ„')+'</p></div><div class="text-left">'+valFn(uid)+'</div></div>'});el.innerHTML=h||'<p class="text-purple-300/30">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>'}

    rank(Object.keys(ua).sort(function(a,b){return ua[b].t-ua[a].t}).slice(0,5),$('d-top'),function(uid){return'<p class="text-lg font-black text-indigo-400">'+ua[uid].t+'</p><p class="text-purple-300/30 text-[10px]">Ù…Ø­Ø§ÙˆÙ„Ø©</p>'});
    rank(Object.keys(ua).filter(function(uid){return ua[uid].t>=3}).sort(function(a,b){return ua[b].c/ua[b].t-ua[a].c/ua[a].t}).slice(0,5),$('d-acc'),function(uid){return'<p class="text-lg font-black text-emerald-400">'+Math.round(ua[uid].c/ua[uid].t*100)+'%</p>'});

    var wa=new Date();wa.setDate(wa.getDate()-7);var ra={};a.forEach(function(x){if(new Date(x.created_at)>=wa)ra[x.user_id]=(ra[x.user_id]||0)+1});
    rank(Object.keys(ra).sort(function(a,b){return ra[b]-ra[a]}).slice(0,5),$('d-act'),function(uid){return'<p class="text-lg font-black text-purple-400">'+ra[uid]+'</p><p class="text-purple-300/30 text-[10px]">Ù‡Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</p>'});

    if(u&&u.length){var nh='';u.sort(function(a,b){return new Date(b.created_at)-new Date(a.created_at)}).slice(0,5).forEach(function(m){nh+='<div class="rr"><span class="text-lg">'+(m.avatar_emoji||'ğŸ‘¤')+'</span><div class="flex-1"><p class="text-white font-bold text-sm">'+(m.full_name||'â€”')+'</p><p class="text-purple-300/30 text-xs">'+(m.email||'')+'</p></div><p class="text-purple-300/30 text-xs">'+(m.created_at?new Date(m.created_at).toLocaleDateString('ar-SA'):'')+'</p></div>'});$('d-new').innerHTML=nh}
}

// â•â•â• QUESTIONS â•â•â•
async function loadQ(){
    var f=$('qf').value,s=$('qs').value.trim().toLowerCase(),qr=sb.from('questions').select('*').order('created_at',{ascending:false});
    if(f!=='all')qr=qr.eq('section',f);var{data}=await qr;if(!data)data=[];
    if(s)data=data.filter(function(q){return q.question_text.toLowerCase().includes(s)});
    var sn={quant:'ÙƒÙ…ÙŠ',verbal:'Ù„ÙØ¸ÙŠ',tahsili:'ØªØ­ØµÙŠÙ„ÙŠ'},h='';
    data.forEach(function(q){
        var img=q.image_url?'<img src="'+q.image_url+'" class="w-16 h-16 rounded-lg object-cover ml-2 flex-shrink-0">':'';
        h+='<div class="glass p-4"><div class="flex items-start justify-between gap-3"><div class="flex-1 flex gap-3">'+img+'<div><span class="bg bg-'+(q.section==='quant'?'m':q.section==='verbal'?'y':'f')+'">'+(sn[q.section]||'')+'</span>'+(q.sub_section?'<span class="text-purple-300/30 text-xs mr-2">'+q.sub_section+'</span>':'')+'<p class="text-sm text-white leading-relaxed mt-1">'+(q.question_text||'Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„ØµÙˆØ±Ø©').substring(0,100)+'</p></div></div><div class="flex gap-1 flex-shrink-0"><button class="bs qact" data-a="preview" data-id="'+q.id+'">ğŸ‘ï¸</button><button class="bs qact" data-a="edit" data-id="'+q.id+'">âœï¸</button><button class="bd qact" data-a="del" data-id="'+q.id+'">ğŸ—‘ï¸</button></div></div></div>'
    });$('q-list').innerHTML=h||'<p class="text-purple-300/30 text-center py-8">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø©</p>';
    document.querySelectorAll('.qact').forEach(function(btn){
        btn.addEventListener('click',function(){
            var id=this.dataset.id,a=this.dataset.a;
            if(a==='preview')previewQ(id);
            if(a==='edit')editQ(id);
            if(a==='del')delQ(id);
        });
    });
}

function openQM(q){
    $('qmT').textContent=q?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„':'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„';$('qm-id').value=q?q.id:'';
    $('qm-sec').value=q?q.section:'quant';updateSubSec();
    if(q&&q.sub_section)$('qm-sub').value=q.sub_section;
    $('qm-txt').value=q?q.question_text:'';
    $('qm-img').value=q?(q.image_url||''):'';
    if(q&&q.image_url){$('qm-prev-img').src=q.image_url;$('qm-preview').classList.remove('hidden')}else{$('qm-preview').classList.add('hidden')}
    $('qm-file').value='';
    var c=q?(q.choices||[]):[];for(var i=0;i<4;i++)$('qm-c'+i).value=c[i]||'';
    $('qm-cor').value=q?q.correct_index:'0';$('qm-exp').value=q?(q.explanation||''):'';
    $('questionM').classList.remove('hidden')
}
function previewImg(inp){if(inp.files&&inp.files[0]){var r=new FileReader();r.onload=function(e){$('qm-prev-img').src=e.target.result;$('qm-preview').classList.remove('hidden')};r.readAsDataURL(inp.files[0])}}
function clearImg(){$('qm-preview').classList.add('hidden');$('qm-img').value='';$('qm-file').value='';$('qm-prev-img').src=''}

async function editQ(id){var{data}=await sb.from('questions').select('*').eq('id',id).single();if(data)openQM(data)}

async function previewQ(id){
    var{data:q}=await sb.from('questions').select('*').eq('id',id).single();
    if(!q)return;
    var sn={quant:'ÙƒÙ…ÙŠ',verbal:'Ù„ÙØ¸ÙŠ',tahsili:'ØªØ­ØµÙŠÙ„ÙŠ'};
    var h='<div class="text-center"><span class="bg bg-'+(q.section==='quant'?'m':q.section==='verbal'?'y':'f')+'">'+(sn[q.section]||'')+'</span>'+(q.sub_section?' <span class="text-purple-300/40 text-xs">'+q.sub_section+'</span>':'')+'</div>';
    if(q.image_url)h+='<div class="rounded-xl overflow-hidden" style="background:rgba(255,255,255,0.95);padding:8px"><img src="'+q.image_url+'" class="w-full rounded-lg"></div>';
    if(q.question_text&&q.question_text!=='Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„ØµÙˆØ±Ø©')h+='<p class="text-white text-center text-base font-bold">'+q.question_text+'</p>';
    var choices=q.choices||[];
    var letters=['Ø£','Ø¨','Ø¬','Ø¯'];
    choices.forEach(function(c,i){
        var isCorrect=i===q.correct_index;
        h+='<div class="flex items-center gap-3 p-3 rounded-xl" style="background:'+(isCorrect?'rgba(16,185,129,0.12);border:1px solid rgba(16,185,129,0.3)':'rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)')+'"><span class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-black flex-shrink-0" style="background:'+(isCorrect?'#10b981':'rgba(99,102,241,0.3)')+';color:#fff">'+letters[i]+'</span><span class="text-white text-sm '+(isCorrect?'font-bold':'')+'">'+(c||'â€”')+'</span>'+(isCorrect?' <span class="text-emerald-400 text-xs mr-auto">âœ“</span>':'')+'</div>';
    });
    if(q.explanation)h+='<div class="p-3 rounded-xl" style="background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15)"><p class="text-yellow-200/70 text-xs font-bold mb-1">ğŸ’¡ Ø§Ù„Ø´Ø±Ø­</p><p class="text-purple-200/60 text-sm">'+q.explanation+'</p></div>';
    $('pv-body').innerHTML=h;$('previewM').classList.remove('hidden');
}

async function uploadImg(){
    var file=$('qm-file').files[0];
    if(!file)return $('qm-img').value||null;
    // Ø¬Ø±Ù‘Ø¨ Ø±ÙØ¹ Ø¹Ù„Ù‰ Storage Ø£ÙˆÙ„
    try{
        var ext=file.name.split('.').pop();var name='q_'+Date.now()+'.'+ext;
        var{data,error}=await sb.storage.from('question-images').upload(name,file,{cacheControl:'3600',upsert:false});
        if(error){
            // Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ bucket â€” Ø­ÙˆÙ‘Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù€ base64 ÙˆØ®Ø²Ù‘Ù†Ù‡Ø§ ÙƒÙ€ data URL
            return await new Promise(function(resolve){
                var reader=new FileReader();
                reader.onload=function(e){resolve(e.target.result)};
                reader.readAsDataURL(file);
            });
        }
        var{data:pub}=sb.storage.from('question-images').getPublicUrl(name);
        return pub.publicUrl;
    }catch(e){
        // Fallback to base64
        return await new Promise(function(resolve){
            var reader=new FileReader();
            reader.onload=function(e){resolve(e.target.result)};
            reader.readAsDataURL(file);
        });
    }
}

async function saveQ2(){
    var id=$('qm-id').value;
    var imgUrl=await uploadImg();
    var obj={
        section:$('qm-sec').value,
        subject:$('qm-sub').value||$('qm-sec').value,
        sub_section:$('qm-sub').value,
        question_text:$('qm-txt').value||'Ø³Ø¤Ø§Ù„ Ø¨Ø§Ù„ØµÙˆØ±Ø©',
        choices:[$('qm-c0').value,$('qm-c1').value,$('qm-c2').value,$('qm-c3').value],
        correct_index:parseInt($('qm-cor').value),
        explanation:$('qm-exp').value,
        image_url:imgUrl||null
    };
    if(!obj.choices[0]){toast('Ø§Ù…Ù„Ø£ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª',false);return}
    var{error}=id?await sb.from('questions').update(obj).eq('id',id):await sb.from('questions').insert(obj);
    if(error){toast('Ø®Ø·Ø£: '+error.message,false);return}
    toast(id?'ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«':'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©',true);$('questionM').classList.add('hidden');loadQ()
}
async function delQ(id){if(!confirm('Ù…ØªØ£ÙƒØ¯ØŸ'))return;await sb.from('attempts').delete().eq('question_id',id);await sb.from('reports').delete().eq('question_id',id);await sb.from('questions').delete().eq('id',id);toast('ØªÙ… Ø§Ù„Ø­Ø°Ù',true);loadQ()}

// â•â•â• USERS â•â•â•
async function loadU(){
    var s=($('us').value||'').trim().toLowerCase();var{data}=await sb.from('profiles').select('*').order('created_at',{ascending:false});if(!data)data=[];
    if(s)data=data.filter(function(u){return(u.full_name||'').toLowerCase().includes(s)||(u.email||'').toLowerCase().includes(s)});
    var h='';data.forEach(function(u){var bg=u.subscription_type==='monthly'?'bg-m':u.subscription_type==='yearly'?'bg-y':'bg-f',lb=u.subscription_type==='monthly'?'Ø´Ù‡Ø±ÙŠ':u.subscription_type==='yearly'?'Ø³Ù†ÙˆÙŠ':'Ù…Ø¬Ø§Ù†ÙŠ';
    h+='<tr class="tr"><td class="p-3"><div class="flex items-center gap-2"><span>'+(u.avatar_emoji||'ğŸ‘¤')+'</span><span class="font-bold">'+(u.full_name||'â€”')+'</span>'+(u.role==='admin'?'<span class="bg bg-a">Ø£Ø¯Ù…Ù†</span>':'')+'</div></td><td class="p-3 text-purple-300/40 text-sm">'+(u.email||'')+'</td><td class="p-3 text-center"><span class="bg '+bg+'">'+lb+'</span></td><td class="p-3 text-center text-purple-300/30 text-xs">'+(u.created_at?new Date(u.created_at).toLocaleDateString('ar-SA'):'')+'</td><td class="p-3 text-center"><button class="bs" onclick="editU(\''+u.id+'\')">âœï¸</button></td></tr>'});
    $('u-list').innerHTML=h
}
async function editU(id){var{data}=await sb.from('profiles').select('*').eq('id',id).single();if(!data)return;$('um-id').value=data.id;$('um-n').value=data.full_name||'';$('um-e').value=data.email||'';$('um-s').value=data.subscription_type||'free';$('um-r').value=data.role||'user';$('userM').classList.remove('hidden')}
async function saveU2(){var{error}=await sb.from('profiles').update({full_name:$('um-n').value,subscription_type:$('um-s').value,role:$('um-r').value}).eq('id',$('um-id').value);if(error)toast('Ø®Ø·Ø£',false);else{toast('ØªÙ…',true);$('userM').classList.add('hidden');loadU()}}

// â•â•â• COUPONS â•â•â•
async function loadC(){var{data}=await sb.from('coupons').select('*').order('created_at',{ascending:false});if(!data||!data.length){$('c-list').innerHTML='<tr><td colspan="7" class="p-6 text-center text-purple-300/30">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙˆØ¨ÙˆÙ†Ø§Øª</td></tr>';return}
var planN={all:'Ø§Ù„ÙƒÙ„',monthly:'Ø´Ù‡Ø±ÙŠ',yearly:'Ø³Ù†ÙˆÙŠ'};var durN={'1':'Ø´Ù‡Ø±','3':'3 Ø£Ø´Ù‡Ø±','6':'6 Ø£Ø´Ù‡Ø±','12':'Ø³Ù†Ø©'};
var h='';data.forEach(function(c){var ok=!c.expires_at||new Date(c.expires_at)>new Date();h+='<tr class="tr"><td class="p-3 font-bold text-indigo-300">'+c.code+'</td><td class="p-3 text-center">'+c.discount_value+(c.discount_type==='percentage'?'%':' Ø±')+'</td><td class="p-3 text-center text-purple-300/40 text-xs">'+(planN[c.plan_type]||'Ø§Ù„ÙƒÙ„')+'</td><td class="p-3 text-center text-purple-300/40 text-xs">'+(durN[c.duration_months]||'-')+'</td><td class="p-3 text-center font-bold">'+(c.used_count||0)+'/'+(c.max_uses||'âˆ')+'</td><td class="p-3 text-center"><span class="bg '+(ok?'bg-y':'bg-f')+'">'+(ok?'ÙØ¹Ù‘Ø§Ù„':'Ù…Ù†ØªÙ‡ÙŠ')+'</span></td><td class="p-3 text-center"><button class="bd" onclick="delC(\''+c.id+'\')">ğŸ—‘ï¸</button></td></tr>'});$('c-list').innerHTML=h}
async function saveC2(){var obj={code:$('cm-c').value.toUpperCase().trim(),discount_type:$('cm-t').value,discount_value:parseFloat($('cm-v').value),plan_type:$('cm-plan').value,duration_months:parseInt($('cm-dur').value),max_uses:parseInt($('cm-x').value)||100,used_count:0,expires_at:$('cm-e').value||null};if(!obj.code||!obj.discount_value){toast('Ø§Ù…Ù„Ø£ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©',false);return}var{error}=await sb.from('coupons').insert(obj);if(error)toast('Ø®Ø·Ø£: '+error.message,false);else{toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†',true);$('couponM').classList.add('hidden');loadC()}}
async function delC(id){if(!confirm('Ø­Ø°ÙØŸ'))return;await sb.from('coupons').delete().eq('id',id);toast('ØªÙ…',true);loadC()}

// â•â•â• FINANCE â•â•â•
async function loadF(){var{data}=await sb.from('profiles').select('subscription_type');if(!data)return;var m=data.filter(function(u){return u.subscription_type==='monthly'}).length,y=data.filter(function(u){return u.subscription_type==='yearly'}).length,f=data.filter(function(u){return!u.subscription_type||u.subscription_type==='free'}).length;$('f-a').textContent=m+y;$('f-m').textContent=m;$('f-y').textContent=y;$('f-f').textContent=f}

// â•â•â• REPORTS â•â•â•
async function loadR(){var{data}=await sb.from('reports').select('*,questions(question_text,section)').order('reported_at',{ascending:false});if(!data||!data.length){$('r-list').innerHTML='<div class="glass p-8 text-center text-purple-300/30">Ù…Ø§ ÙÙŠÙ‡ Ø¨Ù„Ø§ØºØ§Øª</div>';return}var h='';data.forEach(function(r){h+='<div class="glass p-4"><div class="flex items-start justify-between"><div><p class="text-white text-sm">'+(r.questions?r.questions.question_text.substring(0,80)+'...':'Ù…Ø­Ø°ÙˆÙ')+'</p><p class="text-purple-300/40 text-xs mt-1">Ø§Ù„Ø³Ø¨Ø¨: '+(r.reason||'-')+'</p></div><button class="bd" onclick="delR(\''+r.id+'\')">âœ•</button></div></div>'});$('r-list').innerHTML=h}
async function delR(id){await sb.from('reports').delete().eq('id',id);toast('ØªÙ…',true);loadR()}

// â•â•â• STAFF â•â•â•
async function loadST(){var{data}=await sb.from('profiles').select('*').eq('role','admin');if(!data)data=[];var h='';data.forEach(function(s){h+='<tr class="tr"><td class="p-3 font-bold">'+(s.full_name||'â€”')+'</td><td class="p-3 text-purple-300/40">'+(s.email||'')+'</td><td class="p-3 text-center"><span class="bg bg-a">Ø£Ø¯Ù…Ù†</span></td><td class="p-3 text-center">'+(s.id!==me.id?'<button class="bd" onclick="rmST(\''+s.id+'\')">Ø¥Ø²Ø§Ù„Ø©</button>':'<span class="text-purple-300/20 text-xs">Ø£Ù†Øª</span>')+'</td></tr>'});$('st-list').innerHTML=h}
async function saveSt2(){var e=$('sm-e').value.trim();if(!e){toast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„',false);return}var{data:u}=await sb.from('profiles').select('id').eq('email',e).single();if(!u){toast('Ù…Ø§ Ù„Ù‚ÙŠÙ†Ø§ Ø­Ø³Ø§Ø¨',false);return}await sb.from('profiles').update({role:'admin'}).eq('id',u.id);toast('ØªÙ…',true);$('staffM').classList.add('hidden');loadST()}
async function rmST(id){if(!confirm('Ù…ØªØ£ÙƒØ¯ØŸ'))return;await sb.from('profiles').update({role:'user'}).eq('id',id);toast('ØªÙ…',true);loadST()}

// â•â•â• SETTINGS â•â•â•
async function loadSet(){var{data}=await sb.from('site_settings').select('*');if(data)data.forEach(function(s){
    if(s.key==='banner_text')$('st-ban').value=s.value||'';
    if(s.key==='free_limit')$('st-fl').value=s.value||'10';
    if(s.key==='price_monthly')$('st-m').value=s.value||'29';
    if(s.key==='price_yearly')$('st-y').value=s.value||'228';
    if(s.key==='price_monthly_orig')$('st-mo').value=s.value||'39';
    if(s.key==='price_yearly_orig')$('st-yo').value=s.value||'348';
})}
async function saveSt(k,v){var{data:e}=await sb.from('site_settings').select('id').eq('key',k).single();if(e)await sb.from('site_settings').update({value:v}).eq('key',k);else await sb.from('site_settings').insert({key:k,value:v});toast('ØªÙ… Ø§Ù„Ø­ÙØ¸',true)}
function savePrice(){saveSt('price_monthly',$('st-m').value);saveSt('price_yearly',$('st-y').value);saveSt('price_monthly_orig',$('st-mo').value);saveSt('price_yearly_orig',$('st-yo').value)}

updateSubSec();
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
